name: Security Scanning Pipeline

on:
  workflow_dispatch:
    inputs:
      file_name:
        required: true
        type: string
        description: "Input file name"
      command:
        required: true
        type: string
        description: "Command to execute (cat filename and notify will be auto-handled)"
      notification_mode:
        required: false
        type: choice
        default: "line"
        description: "Notification mode"
        options:
          - line
          - bulk
      bulk_filename:
        required: false
        type: string
        default: "results.txt"
        description: "Output filename for bulk mode (only used when notification_mode is bulk)"

jobs:
  scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Cache tools
        id: cache-tools
        uses: actions/cache@v4
        with:
          path: ~/tools
          key: pdtools-v2-${{ runner.os }}
          
      - name: Install security tools
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          echo "[*] Installing ProjectDiscovery tools (not cached)..."
          mkdir -p ~/tools
          
          # Download pre-compiled binaries (much faster than go install)
          echo "[*] Downloading subfinder..."
          wget -q https://github.com/projectdiscovery/subfinder/releases/latest/download/subfinder_2.8.0_linux_amd64.zip
          unzip -o -q subfinder_2.8.0_linux_amd64.zip
          mv subfinder ~/tools/
          
          echo "[*] Downloading httpx..."
          wget -q https://github.com/projectdiscovery/httpx/releases/latest/download/httpx_1.7.1_linux_amd64.zip
          unzip -o -q httpx_1.7.1_linux_amd64.zip
          mv httpx ~/tools/
          
          echo "[*] Downloading nuclei..."
          wget -q https://github.com/projectdiscovery/nuclei/releases/latest/download/nuclei_3.4.10_linux_amd64.zip
          unzip -o -q nuclei_3.4.10_linux_amd64.zip
          mv nuclei ~/tools/
          
          echo "[*] Downloading katana..."
          wget -q https://github.com/projectdiscovery/katana/releases/latest/download/katana_1.2.1_linux_amd64.zip
          unzip -o -q katana_1.2.1_linux_amd64.zip
          mv katana ~/tools/
          
          echo "[*] Downloading notify..."
          wget -q https://github.com/projectdiscovery/notify/releases/download/v1.0.7/notify_1.0.7_linux_amd64.zip
          unzip -o -q notify_1.0.7_linux_amd64.zip
          mv notify ~/tools/
          
          chmod +x ~/tools/*
          echo "[+] Tools downloaded successfully"
          
      - name: Setup tool paths
        run: |
          # Add tools to PATH
          echo "$HOME/tools" >> $GITHUB_PATH
          
          # Verify installations
          echo "[*] Verifying tool installations..."
          ~/tools/subfinder -version || echo "subfinder not found"
          ~/tools/httpx -version || echo "httpx not found" 
          ~/tools/nuclei -version || echo "nuclei not found"
          ~/tools/katana -version || echo "katana not found"
          ~/tools/notify -version || echo "notify not found"
          
      - name: Cache nuclei templates
        id: cache-templates
        uses: actions/cache@v4
        with:
          path: nuclei-templates
          key: nuclei-templates-${{ github.run_id }}
          restore-keys: nuclei-templates-
          
      - name: Clone nuclei templates
        if: steps.cache-templates.outputs.cache-hit != 'true'
        run: |
          echo "[*] Cloning nuclei templates..."
          git clone --depth 1 https://github.com/projectdiscovery/nuclei-templates.git
          echo "[+] Templates cloned"
          
      - name: Create notify credentials file
        env:
          TELEGRAM_API_KEY: ${{ secrets.TELEGRAM_API_KEY }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "[*] Creating temporary notify credentials file..."
          cat > temp_creds.yml << EOF
          telegram:
            - id: "tel"
              telegram_api_key: "$TELEGRAM_API_KEY"
              telegram_chat_id: "$TELEGRAM_CHAT_ID"
              telegram_format: "{{data}}"
              telegram_parsemode: "Markdown"
          EOF
          echo "[+] Temporary credentials file created"
          
      - name: Verify input file exists
        run: |
          if [ ! -f "upload/${{ inputs.file_name }}" ]; then
            echo "[!] Input file upload/${{ inputs.file_name }} not found in repository"
            echo "[*] Available files in upload directory:"
            ls -la upload/ || echo "Upload directory doesn't exist"
            exit 1
          fi
          echo "[+] Input file upload/${{ inputs.file_name }} found"
          echo "[*] File size: $(wc -l < upload/${{ inputs.file_name }}) lines"
          
      - name: Execute scanning pipeline
        run: |
          echo "[*] Building pipeline..."
          echo "[*] Input file: upload/${{ inputs.file_name }}"
          echo "[*] Command: ${{ inputs.command }}"
          echo "[*] Notification mode: ${{ inputs.notification_mode }}"
          
          # Determine notification command based on mode
          if [ "${{ inputs.notification_mode }}" = "bulk" ]; then
            # For bulk mode, save output to file first, then send via notify -data
            BULK_FILE="${{ inputs.bulk_filename }}"
            echo "[*] Bulk mode: saving results to $BULK_FILE"
            
            # Build pipeline with output redirection
            SCAN_PIPELINE="cat upload/${{ inputs.file_name }} | ${{ inputs.command }} > $BULK_FILE"
            NOTIFY_PIPELINE="notify -pc temp_creds.yml -silent -data $BULK_FILE"
            
            echo "[*] Scan pipeline: $SCAN_PIPELINE"
            echo "[*] Notify pipeline: $NOTIFY_PIPELINE"
          else
            # For line mode (default), use standard piping
            echo "[*] Line mode: sending results line by line"
            FULL_PIPELINE="cat upload/${{ inputs.file_name }} | ${{ inputs.command }} | notify -pc temp_creds.yml -silent"
            echo "[*] Full pipeline: $FULL_PIPELINE"
          fi
          
          echo "[*] Started at: $(date)"
          
          # Execute the pipeline with error handling
          if [ "${{ inputs.notification_mode }}" = "bulk" ]; then
            # Execute scan pipeline first
            if eval "$SCAN_PIPELINE"; then
              echo "[+] Scan completed successfully"
              
              # Check if results file exists and has content
              if [ -f "$BULK_FILE" ] && [ -s "$BULK_FILE" ]; then
                echo "[*] Results file created with $(wc -l < $BULK_FILE) lines"
                echo "[*] Sending bulk notification..."
                
                # Send bulk notification
                if eval "$NOTIFY_PIPELINE"; then
                  echo "[+] Bulk notification sent successfully"
                else
                  echo "[!] Bulk notification failed"
                  exit 1
                fi
              else
                echo "[*] No results to send (empty or missing results file)"
                echo "ℹ️ Scan completed but no results found for upload/${{ inputs.file_name }}" | notify -pc temp_creds.yml -silent || true
              fi
            else
              echo "[!] Scan pipeline failed with exit code $?"
              echo "❌ Scanning failed for upload/${{ inputs.file_name }}" | notify -pc temp_creds.yml -silent || true
              exit 1
            fi
          else
            # Execute line mode pipeline
            if eval "$FULL_PIPELINE"; then
              echo "[+] Pipeline completed successfully"
            else
              echo "[!] Pipeline failed with exit code $?"
              echo "❌ Scanning failed for upload/${{ inputs.file_name }}" | notify -pc temp_creds.yml -silent || true
              exit 1
            fi
          fi
          
          echo "[*] Completed at: $(date)"
          
      - name: Upload results (bulk mode only)
        if: inputs.notification_mode == 'bulk'
        uses: actions/upload-artifact@v4
        with:
          name: scan-results
          path: ${{ inputs.bulk_filename }}
          retention-days: 7
          
      - name: Cleanup
        if: always()
        run: |
          # Clean up temporary files
          rm -f temp_creds.yml
          rm -f ${{ inputs.bulk_filename }} 2>/dev/null || true
          rm -rf nuclei-templates
          echo "[+] Cleanup completed"
